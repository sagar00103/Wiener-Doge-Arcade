<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiener Doge Spin Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Initialize global variables from the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            setLogLevel('Debug'); // Enable debug logging for troubleshooting
            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);

            // Handle Authentication
            if (initialAuthToken) {
                signInWithCustomToken(window.auth, initialAuthToken).catch(e => {
                    console.error("Custom token sign-in failed:", e);
                    signInAnonymously(window.auth);
                });
            } else {
                signInAnonymously(window.auth);
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        .slot-reel {
            transition: transform 0.1s ease-out;
            will-change: transform;
        }
        .status-box {
            background-color: #282828;
            border-left: 4px solid #FDCB6E;
        }
        .button-primary {
            background-color: #FDCB6E;
            color: #121212;
            font-weight: 900;
            transition: all 0.15s;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #fcae39;
            transform: scale(1.02);
            box-shadow: 0 8px 15px rgba(253, 203, 110, 0.3);
        }
        .button-primary:disabled {
            background-color: #404040;
            color: #888888;
            cursor: not-allowed;
        }
        .reel-container {
            border: 4px solid #FDCB6E;
            box-shadow: 0 0 20px rgba(253, 203, 110, 0.4);
            background: linear-gradient(145deg, #1d1d1d, #252525);
        }
        /* Mobile Menu Styles */
        #menu-panel {
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            background-color: #1A1A1A; /* Darker background for contrast */
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.5);
            color: #E0E0E0;
        }
        #menu-panel.open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- Menu Panel (Hidden by default) -->
    <div id="menu-panel" class="fixed top-0 left-0 h-full w-full max-w-sm p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-6 border-b pb-4 border-gray-700">
            <h2 class="text-3xl font-black text-white">Dashboard</h2>
            <button id="close-menu-btn" class="text-white hover:text-red-400 p-2 rounded-full transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>

        <!-- Wallet and Stats Section -->
        <div class="space-y-6">
            <h3 class="text-2xl font-bold text-yellow-400">Connect Your Wiener Doge Staking Wallet</h3>
            
            <p class="text-sm text-gray-400">Wiener Doge Contract Address (CA): <span class="font-mono break-all text-yellow-300 text-xs">CceCXFy4UeXheTpf8sn1bpECxMQeH5BTyxQK4BdRMf2T</span></p>

            <input type="text" id="wallet-input" placeholder="Enter Staking Wallet Address" 
                class="w-full p-3 rounded-xl bg-gray-700 border border-yellow-500 text-white placeholder-gray-400 focus:ring-yellow-500 focus:border-yellow-500 transition duration-150">

            <button id="save-wallet-btn" class="w-full p-3 rounded-xl bg-yellow-600 text-black font-bold hover:bg-yellow-500 transition duration-150">Save Wallet Address</button>
            
            <a href="https://t.me/wienerdogestaking" target="_blank" class="block text-center text-sm text-yellow-400 hover:text-yellow-300 mt-3 underline transition duration-150">
                Don't have a staking wallet? Click here.
            </a>
            
            <div class="space-y-2 border-t pt-4 border-gray-700">
                <h4 class="text-xl font-bold text-white">Your Stats</h4>
                <p id="telegram-username-display" class="text-gray-400">Telegram Username: N/A</p>
                <p id="user-id-display" class="text-gray-400 break-all text-xs">Telegram/Firebase User ID: N/A</p>
                <p id="wallet-display" class="text-gray-400 break-all text-xs">Staking Wallet: N/A</p>
                <p id="spins-used-display" class="text-gray-400">Spins Used: 0</p>
            </div>
        </div>
        
    </div>

    <!-- Main Content -->
    <header class="w-full flex justify-between items-center p-4 bg-black/50 backdrop-blur-sm sticky top-0 z-40 shadow-lg">
        <button id="open-menu-btn" class="text-yellow-400 p-2 rounded-xl hover:bg-gray-800 transition duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        </button>
        <h1 class="text-3xl font-black text-white tracking-wider">WIENER SPIN</h1>
        <div class="w-8 h-8"></div>
    </header>

    <main class="flex flex-col items-center p-4 w-full max-w-md flex-grow">
        
        <!-- Status & Balance -->
        <div id="status-box" class="status-box p-4 rounded-xl w-full mb-8">
            <p id="status-display" class="font-bold">Connecting to game server...</p>
            <p class="text-sm mt-1">
                Balance: <span id="balance-display" class="font-mono text-yellow-300">N/A</span>
            </p>
        </div>

        <h2 class="text-4xl font-extrabold text-white mb-2">777 DOGE SPIN</h2>
        <p class="text-lg font-bold text-gray-400 mb-8">Cost: 1 Wiener Doge per spin</p>

        <!-- Slot Machine -->
        <div id="slot-machine" class="flex justify-center space-x-2 w-full mb-8">
            <!-- Reel 1 -->
            <div class="reel-container h-32 w-1/3 rounded-xl overflow-hidden relative">
                <div id="reel-1" class="slot-reel absolute inset-0 flex flex-col justify-center items-center text-5xl font-extrabold text-white">
                    <span class="py-2 h-full flex items-center justify-center">üå≠</span>
                    <span class="py-2 h-full flex items-center justify-center">ü¶¥</span>
                    <span class="py-2 h-full flex items-center justify-center">üê∂</span>
                    <span class="py-2 h-full flex items-center justify-center">7Ô∏è‚É£</span>
                    <span class="py-2 h-full flex items-center justify-center">üå≠</span>
                </div>
            </div>

            <!-- Reel 2 -->
            <div class="reel-container h-32 w-1/3 rounded-xl overflow-hidden relative">
                <div id="reel-2" class="slot-reel absolute inset-0 flex flex-col justify-center items-center text-5xl font-extrabold text-white">
                    <span class="py-2 h-full flex items-center justify-center">ü¶¥</span>
                    <span class="py-2 h-full flex items-center justify-center">üê∂</span>
                    <span class="py-2 h-full flex items-center justify-center">7Ô∏è‚É£</span>
                    <span class="py-2 h-full flex items-center justify-center">üå≠</span>
                    <span class="py-2 h-full flex items-center justify-center">ü¶¥</span>
                </div>
            </div>

            <!-- Reel 3 -->
            <div class="reel-container h-32 w-1/3 rounded-xl overflow-hidden relative">
                <div id="reel-3" class="slot-reel absolute inset-0 flex flex-col justify-center items-center text-5xl font-extrabold text-white">
                    <span class="py-2 h-full flex items-center justify-center">üê∂</span>
                    <span class="py-2 h-full flex items-center justify-center">7Ô∏è‚É£</span>
                    <span class="py-2 h-full flex items-center justify-center">üå≠</span>
                    <span class="py-2 h-full flex items-center justify-center">ü¶¥</span>
                    <span class="py-2 h-full flex items-center justify-center">üê∂</span>
                </div>
            </div>
        </div>

        <!-- Spin Button -->
        <button id="spin-button" class="button-primary w-full p-4 rounded-2xl text-xl shadow-lg" disabled>
            SPIN FOR WIENER!
        </button>
        <p id="spin-disabled-msg" class="text-sm text-red-500 font-bold mt-3 hidden">
            Insufficient Wiener Doge balance or wallet not connected.
        </p>

    </main>

    <!-- Socials Footer -->
    <footer class="w-full max-w-md p-6 mt-auto">
        <h3 class="text-center text-lg font-bold text-yellow-400 mb-4">Official Wiener Doge Links</h3>
        <div class="flex flex-wrap justify-center space-x-4">
            <a href="https://t.me/WienerDogeonSol" target="_blank" class="text-gray-400 hover:text-yellow-400 transition duration-150 p-2" title="Telegram Main Community">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M11.944 0a12 12 0 1 0 12 12 12 12 0 0 0 -12 -12Zm6.426 8.528l-2.008 9.421c-.244 1.15-.996 1.432-1.802.946l-4.227-3.134-1.996 1.933c-.227.227-.417.417-.833.417l.322-4.298 7.82-7.052c.365-.327-.107-.502-.6-.18l-6.382 3.963-4.238-1.325c-1.139-.356-1.164-1.1-.24-1.428l15.143-5.833c.895-.36 1.666.19 1.378 1.472Z"/></svg>
            </a>
            <a href="https://x.com/wiener_doge_sol" target="_blank" class="text-gray-400 hover:text-yellow-400 transition duration-150 p-2" title="X (Twitter)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M18.9 1.5H22l-8.5 10.3L23 22H16l-5.6-7.1L4.8 22H1.8l8.2-10L1 1.5h4.1l4.9 6.5L16.2 1.5h2.7zM6.9 3.1L15.4 20.9h2.3L9.5 3.1H6.9z"/></svg>
            </a>
            <a href="https://dexscreener.com/solana/eg39azdncmui8hrbttmpnc85ptq8ubgbyhskszaf7nzc" target="_blank" class="text-gray-400 hover:text-yellow-400 transition duration-150 p-2" title="DEX Screener">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-activity"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            </a>
            <a href="https://wienerdogesol.com" target="_blank" class="text-gray-400 hover:text-yellow-400 transition duration-150 p-2" title="Official Website">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
            </a>
            <a href="https://solsea.io/c/67c235ad74de44f763bee2ce" target="_blank" class="text-gray-400 hover:text-yellow-400 transition duration-150 p-2" title="NFT Collection (Solsea)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gem"><path d="M6 3h12l3 6-9 12-9-12 3-6z"/></svg>
            </a>
            <a href="https://www.tiktok.com/@wienerdogesol" target="_blank" class="text-gray-400 hover:text-yellow-400 transition duration-150 p-2" title="TikTok">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M18.8 9.5c0-.6.5-1.1 1.1-1.1.6 0 1.1.5 1.1 1.1s-.5 1.1-1.1 1.1c-.6 0-1.1-.5-1.1-1.1zm-3.6 0c0-.6.5-1.1 1.1-1.1.6 0 1.1.5 1.1 1.1s-.5 1.1-1.1 1.1c-.6 0-1.1-.5-1.1-1.1zm-3.6 0c0-.6.5-1.1 1.1-1.1.6 0 1.1.5 1.1 1.1s-.5 1.1-1.1 1.1c-.6 0-1.1-.5-1.1-1.1zm-3.6 0c0-.6.5-1.1 1.1-1.1.6 0 1.1.5 1.1 1.1s-.5 1.1-1.1 1.1c-.6 0-1.1-.5-1.1-1.1zM12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm2.5 14h-5c-.3 0-.5-.2-.5-.5s.2-.5.5-.5h5c.3 0 .5.2.5.5s-.2.5-.5.5z"/></svg>
            </a>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script type="module">
        // --- CONSTANTS AND SETUP ---
        // IMPORTANT: Replace this with the live HTTPS URL of your PythonAnywhere backend server.
        // E.g., 'https://yourusername.pythonanywhere.com'
        const BACKEND_URL = 'https://sagar00101.pythonanywhere.com/'; 
        
        const slotSymbols = ['üê∂', 'ü¶¥', 'üå≠', '7Ô∏è‚É£'];
        const REEL_CONFIG = [
            { id: 'reel-1', symbols: ['üå≠', 'ü¶¥', 'üê∂', '7Ô∏è‚É£', 'üå≠'] },
            { id: 'reel-2', symbols: ['ü¶¥', 'üê∂', '7Ô∏è‚É£', 'üå≠', 'ü¶¥'] },
            { id: 'reel-3', symbols: ['üê∂', '7Ô∏è‚É£', 'üå≠', 'ü¶¥', 'üê∂'] }
        ];
        const SPIN_COST = 1.0;
        
        // Global State (persisted via Firebase/localStorage for testing)
        window.stats = {
            userId: null,
            telegramUsername: 'N/A',
            walletAddress: '',
            spinsUsed: 0
        };
        window.currentBalance = 0;
        let isSpinning = false;
        
        // Elements
        const menuPanel = document.getElementById('menu-panel');
        const openMenuBtn = document.getElementById('open-menu-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const walletInput = document.getElementById('wallet-input');
        const saveWalletBtn = document.getElementById('save-wallet-btn');
        const spinButton = document.getElementById('spin-button');
        const statusDisplay = document.getElementById('status-display');
        const balanceDisplay = document.getElementById('balance-display');
        const spinDisabledMsg = document.getElementById('spin-disabled-msg');
        
        const reelElements = [
            document.getElementById('reel-1'),
            document.getElementById('reel-2'),
            document.getElementById('reel-3')
        ];

        // --- FIREBASE/STATE MANAGEMENT ---

        /**
         * Attaches Firestore listener to load user data and subscribe to changes.
         */
        const setupFirestoreListener = (userId) => {
            if (!window.db) {
                console.error("Firestore not initialized.");
                statusDisplay.textContent = "Error: Database failed to initialize.";
                spinButton.disabled = true;
                return;
            }

            // Path for user data: /artifacts/{appId}/users/{userId}/game_stats/stats
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userStatsRef = doc(window.db, `artifacts/${appId}/users/${userId}/game_stats/stats`);

            // Use onSnapshot for real-time updates
            onSnapshot(userStatsRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                
                // Initialize/update state from Firestore
                window.stats.walletAddress = data.walletAddress || '';
                window.stats.spinsUsed = data.spinsUsed || 0;
                window.stats.telegramUsername = data.telegramUsername || window.stats.telegramUsername;
                
                // Update UI fields
                walletInput.value = window.stats.walletAddress;
                document.getElementById('wallet-display').textContent = `Staking Wallet: ${window.stats.walletAddress || 'N/A'}`;
                document.getElementById('spins-used-display').textContent = `Spins Used: ${window.stats.spinsUsed}`;
                
                // After loading wallet, check balance
                if (window.stats.walletAddress) {
                    checkBalanceAndEnableSpin(window.stats.walletAddress);
                } else {
                    statusDisplay.textContent = "Please connect your Staking Wallet to play.";
                    checkBalanceAndEnableSpin(); // Disable if no wallet
                }
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                statusDisplay.textContent = "Error loading stats. Check console for details.";
            });
        };

        /**
         * Saves or updates the wallet address and Telegram details in Firestore.
         */
        const saveWalletAddress = async () => {
            const address = walletInput.value.trim();
            if (!address) {
                alertModal("Please enter a valid wallet address.");
                return;
            }
            if (!window.db || !window.stats.userId) return;

            saveWalletBtn.disabled = true;
            saveWalletBtn.textContent = 'Saving...';

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userStatsRef = doc(window.db, `artifacts/${appId}/users/${window.stats.userId}/game_stats/stats`);
                
                await setDoc(userStatsRef, {
                    walletAddress: address,
                    spinsUsed: window.stats.spinsUsed,
                    telegramUsername: window.stats.telegramUsername,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });

                alertModal("Wallet Saved!", "Your staking wallet address has been successfully saved.");
            } catch (error) {
                console.error("Error saving wallet:", error);
                alertModal("Error", "Could not save wallet address. Try again.");
            } finally {
                saveWalletBtn.disabled = false;
                saveWalletBtn.textContent = 'Save Wallet Address';
            }
        };

        // --- API CALLS (Requires Backend) ---

        /**
         * Fetches balance from the secure backend and updates the spin button state.
         * This function requires your PythonAnywhere server to be running.
         */
        const checkBalanceAndEnableSpin = async (walletAddress) => {
            spinButton.disabled = true; // Default to disabled while checking
            balanceDisplay.textContent = 'Checking...';
            
            if (!walletAddress) {
                balanceDisplay.textContent = 'N/A';
                spinDisabledMsg.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/get-balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: window.stats.userId,
                        telegramInitData: Telegram.WebApp.initData, // Security check
                        walletAddress: walletAddress 
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server returned status ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Update balance state and UI
                window.currentBalance = parseFloat(data.balance);
                balanceDisplay.textContent = `${window.currentBalance.toFixed(2)} Wiener Doge`;

                // Enable/Disable Spin Button based on Balance
                if (window.currentBalance >= SPIN_COST) {
                    spinButton.disabled = false;
                    spinDisabledMsg.style.display = 'none';
                    statusDisplay.textContent = `Balance sufficient! Ready to spin (Cost: ${SPIN_COST} Wiener Doge).`;
                } else {
                    spinButton.disabled = true;
                    spinDisabledMsg.style.display = 'block';
                    statusDisplay.textContent = `Insufficient Wiener Doge balance (Need ${SPIN_COST} Wiener Doge to spin).`;
                }

            } catch (error) {
                console.error("Error checking balance:", error);
                statusDisplay.textContent = `Error checking balance: Load failed. Is your backend running?`;
                balanceDisplay.textContent = 'N/A';
                spinButton.disabled = true;
                spinDisabledMsg.style.display = 'block';
            }
        };

        /**
         * Sends the spin request to the secure backend.
         * The backend handles the virtual deduction (Firestore update) and determines the secure win/loss result.
         */
        const fetchSpinResult = async () => {
            statusDisplay.textContent = "Sending spin request to server...";
            spinButton.disabled = true;
            isSpinning = true;

            try {
                const response = await fetch(`${BACKEND_URL}/api/spin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: window.stats.userId,
                        telegramInitData: Telegram.WebApp.initData, // Security check
                        walletAddress: window.stats.walletAddress
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${errorText}`);
                }

                const data = await response.json();

                if (data.error) {
                    // This handles errors like "Insufficient funds" from the server
                    throw new Error(data.error);
                }

                // Server returns the three final symbols
                return data.result; 

            } catch (error) {
                console.error("Spin request failed:", error);
                statusDisplay.textContent = `Spin failed! Error: ${error.message}`;
                isSpinning = false;
                // Re-enable/re-check state
                checkBalanceAndEnableSpin(window.stats.walletAddress);
                // Return fallback result to stop animation cleanly
                return ['ü¶¥', 'ü¶¥', 'ü¶¥']; 
            }
        };

        // --- SLOT MACHINE ANIMATION AND GAME LOGIC ---

        /**
         * Animates a single reel.
         * @param {HTMLElement} reelElement - The DOM element for the reel.
         * @param {string} finalSymbol - The symbol the reel must land on.
         * @param {number} delay - Delay before starting this reel's animation.
         */
        const animateReel = (reelElement, finalSymbol, delay) => {
            const symbols = REEL_CONFIG.find(c => c.id === reelElement.id).symbols;
            const symbolHeight = reelElement.clientHeight; // Height of the viewable area (1 symbol)
            const symbolIndex = symbols.indexOf(finalSymbol); 
            
            // Calculate target position based on symbol index (index 0 is the top of the roll)
            // The symbols in the DOM are stacked, so we target the correct offset.
            // We use a safe distance (e.g., 3 full rolls) to ensure a good visual effect before stopping.
            const baseRolls = 5; 
            const offsetForSymbol = symbolIndex * symbolHeight;
            const totalDistance = (baseRolls * symbols.length * symbolHeight) + offsetForSymbol;
            
            return new Promise(resolve => {
                setTimeout(() => {
                    // Set animation duration
                    const duration = 2000 + Math.random() * 500; // 2.0s to 2.5s for the effect
                    
                    reelElement.style.transition = `transform ${duration}ms cubic-bezier(0.25, 0.1, 0.25, 1)`;
                    reelElement.style.transform = `translateY(-${totalDistance}px)`;

                    reelElement.addEventListener('transitionend', function handler(e) {
                        // Reset transition style for next spin
                        reelElement.style.transition = 'none';
                        
                        // Recalculate position to snap back to a non-rolled state while keeping the symbol visible
                        const normalizedDistance = offsetForSymbol % (symbols.length * symbolHeight);
                        reelElement.style.transform = `translateY(-${normalizedDistance}px)`;

                        reelElement.removeEventListener('transitionend', handler);
                        resolve();
                    });
                }, delay);
            });
        };

        /**
         * Main function to handle the spin process.
         */
        const handleSpin = async () => {
            if (isSpinning || spinButton.disabled) return;
            if (window.currentBalance < SPIN_COST) {
                statusDisplay.textContent = `Cannot spin. You need ${SPIN_COST} Wiener Doge.`;
                return;
            }

            statusDisplay.textContent = "SPINNING...";
            spinButton.disabled = true;
            isSpinning = true;

            // 1. Fetch the secure result from the backend
            const finalSymbols = await fetchSpinResult();

            // 2. Animate the Reels
            const promises = reelElements.map((reel, index) => 
                animateReel(reel, finalSymbols[index], index * 500) // Stagger start time
            );

            // 3. Wait for all animations to complete
            await Promise.all(promises);

            // 4. Update UI based on result and virtual deduction
            isSpinning = false;
            
            // Deduct the spin cost (virtually, the backend handled the Firestore update)
            window.currentBalance -= SPIN_COST; 
            if (window.currentBalance < 0) window.currentBalance = 0;

            // Determine win/loss based on the secure result
            const isWin = finalSymbols[0] === finalSymbols[1] && finalSymbols[1] === finalSymbols[2] && finalSymbols[0] === '7Ô∏è‚É£';

            if (isWin) {
                statusDisplay.textContent = "JACKPOT! 7Ô∏è‚É£7Ô∏è‚É£7Ô∏è‚É£ - Owner has been notified.";
            } else {
                statusDisplay.textContent = "No luck this time! Try again.";
            }

            balanceDisplay.textContent = `${window.currentBalance.toFixed(2)} Wiener Doge`;

            // 5. Re-check balance to re-enable or disable button
            checkBalanceAndEnableSpin(window.stats.walletAddress);

            // Update Firebase for the new spinsUsed count (only if backend didn't update it)
            // Note: The ideal setup is the backend handles this, but we'll add client update as fallback.
            if (window.db && window.stats.userId) {
                 const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                 const userStatsRef = doc(window.db, `artifacts/${appId}/users/${window.stats.userId}/game_stats/stats`);
                 await setDoc(userStatsRef, { spinsUsed: window.stats.spinsUsed + 1 }, { merge: true });
            }
        };

        // --- UTILITY ---
        const alertModal = (title, message) => {
             // Use Telegram SDK popup if available, otherwise fallback to simple alert box UI
             if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.showAlert(`${title}: ${message}`);
             } else {
                 const modal = document.createElement('div');
                 modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[100]';
                 modal.innerHTML = `
                     <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full space-y-4">
                         <h3 class="text-xl font-bold text-yellow-400">${title}</h3>
                         <p class="text-white">${message}</p>
                         <button id="close-modal" class="w-full p-2 bg-yellow-600 text-black rounded-lg font-bold">Close</button>
                     </div>
                 `;
                 document.body.appendChild(modal);
                 document.getElementById('close-modal').onclick = () => document.body.removeChild(modal);
             }
         };

        // --- INITIALIZATION ---
        
        /**
         * Runs when the app is first loaded.
         */
        window.onload = () => {
            // Get user data from Telegram SDK
            let tgData = {};
            if (window.Telegram && window.Telegram.WebApp) {
                tgData = Telegram.WebApp.initDataUnsafe.user || {};
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
            }

            // Determine userId. Use Firebase auth UID if available, otherwise TG ID or random ID.
            window.auth?.onAuthStateChanged(user => {
                if (user) {
                    window.stats.userId = user.uid; // Firebase UID
                    
                    // Set Telegram details from SDK
                    window.stats.telegramUsername = tgData.username ? `@${tgData.username}` : 'N/A';
                    
                    // Update menu UI immediately
                    document.getElementById('telegram-username-display').textContent = `Telegram Username: ${window.stats.telegramUsername}`;
                    document.getElementById('user-id-display').textContent = `Telegram/Firebase User ID: ${window.stats.userId}`;

                    // Start listening for game stats
                    setupFirestoreListener(window.stats.userId);
                } else {
                    console.log("User not authenticated.");
                    statusDisplay.textContent = "Authenticating user failed. Cannot play.";
                    spinButton.disabled = true;
                }
            });

            // Set up event listeners
            openMenuBtn.addEventListener('click', () => {
                menuPanel.classList.add('open');
            });
            closeMenuBtn.addEventListener('click', () => {
                menuPanel.classList.remove('open');
            });
            saveWalletBtn.addEventListener('click', saveWalletAddress);
            spinButton.addEventListener('click', handleSpin);

            // Initial state check (will be overwritten by Firestore)
            statusDisplay.textContent = "Authenticating user...";
        };
    </script>
</body>
</html>
